# =============================================================================
# GITHUB ACTIONS - CI/CD para Projeto Django
# =============================================================================
# Este workflow √© executado automaticamente quando:
# - H√° um push para as branches main ou develop
# - Uma Pull Request √© aberta para main ou develop
#
# O que ele faz:
# 1. Configura o ambiente Python
# 2. Instala as depend√™ncias
# 3. Executa verifica√ß√µes de c√≥digo (linting)
# 4. Roda os testes automatizados
# 5. Verifica as migra√ß√µes do Django

name: Django CI

# Gatilhos: quando o workflow deve ser executado
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Vari√°veis de ambiente globais
env:
  PYTHON_VERSION: '3.12'

jobs:
  # ===========================================================================
  # JOB: Build e Teste
  # ===========================================================================
  build-and-test:
    name: Build e Teste
    runs-on: ubuntu-latest
    
    # Estrat√©gia de matriz: permite testar em m√∫ltiplas vers√µes do Python
    strategy:
      max-parallel: 4
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      # -----------------------------------------------------------------------
      # Passo 1: Checkout do c√≥digo
      # -----------------------------------------------------------------------
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
      
      # -----------------------------------------------------------------------
      # Passo 2: Configurar Python
      # -----------------------------------------------------------------------
      - name: üêç Configurar Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'  # Cache das depend√™ncias para builds mais r√°pidos
      
      # -----------------------------------------------------------------------
      # Passo 3: Instalar depend√™ncias
      # -----------------------------------------------------------------------
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Instala depend√™ncias de teste
          pip install flake8 coverage
      
      # -----------------------------------------------------------------------
      # Passo 4: Verificar c√≥digo com Flake8 (Linting)
      # -----------------------------------------------------------------------
      - name: üîç Verificar c√≥digo com Flake8
        run: |
          # Para erros de sintaxe e problemas cr√≠ticos
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=Lib,venv,.git,__pycache__,migrations
          # Verifica complexidade e estilo (avisos, n√£o bloqueia)
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=Lib,venv,.git,__pycache__,migrations
      
      # -----------------------------------------------------------------------
      # Passo 5: Verificar migra√ß√µes do Django
      # -----------------------------------------------------------------------
      - name: üóÉÔ∏è Verificar migra√ß√µes
        run: |
          python manage.py makemigrations --check --dry-run
        env:
          SECRET_KEY: 'github-actions-secret-key-for-testing'
          DEBUG: 'True'
      
      # -----------------------------------------------------------------------
      # Passo 6: Executar migra√ß√µes
      # -----------------------------------------------------------------------
      - name: üîÑ Aplicar migra√ß√µes
        run: |
          python manage.py migrate
        env:
          SECRET_KEY: 'github-actions-secret-key-for-testing'
          DEBUG: 'True'
      
      # -----------------------------------------------------------------------
      # Passo 7: Executar testes
      # -----------------------------------------------------------------------
      - name: ‚úÖ Executar testes
        run: |
          coverage run --source='.' manage.py test
          coverage report
        env:
          SECRET_KEY: 'github-actions-secret-key-for-testing'
          DEBUG: 'True'
      
      # -----------------------------------------------------------------------
      # Passo 8: Verificar sistema Django
      # -----------------------------------------------------------------------
      - name: üè• Verificar sistema Django
        run: |
          python manage.py check
        env:
          SECRET_KEY: 'github-actions-secret-key-for-testing'
          DEBUG: 'True'

  # ===========================================================================
  # JOB: An√°lise de Seguran√ßa (opcional, roda em paralelo)
  # ===========================================================================
  security-check:
    name: Verifica√ß√£o de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
      
      - name: üêç Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: üì¶ Instalar depend√™ncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit
      
      - name: üîí Verificar vulnerabilidades nas depend√™ncias
        run: |
          pip install pip-audit
          pip-audit || true  # N√£o falha o build, apenas avisa
        continue-on-error: true
      
      - name: üõ°Ô∏è An√°lise de seguran√ßa do c√≥digo com Bandit
        run: |
          bandit -r . -x ./Lib,./venv,./.git,./migrations -ll || true
        continue-on-error: true
